<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>METRO-TECH: Pro Subway Simulator</title>
    <style>
        :root { --display: #00ffcc; --bg: #050505; }
        body { margin: 0; overflow: hidden; background: var(--bg); font-family: 'Consolas', monospace; }
        #ui { position: absolute; inset: 0; pointer-events: none; color: var(--display); padding: 25px; }
        
        /* HUD ELEMENTS */
        .glass-panel { background: rgba(0, 20, 20, 0.8); border: 1px solid var(--display); padding: 15px; border-radius: 4px; box-shadow: 0 0 15px rgba(0, 255, 204, 0.2); }
        .speedometer { position: absolute; bottom: 40px; right: 40px; text-align: right; }
        .speed-val { font-size: 72px; font-weight: bold; line-height: 0.8; }
        .station-info { position: absolute; top: 40px; left: 50%; transform: translateX(-50%); text-align: center; width: 300px; }
        
        /* OVERLAYS */
        .overlay { position: absolute; inset: 0; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; pointer-events: all; }
        .btn { background: var(--display); color: #000; border: none; padding: 15px 40px; font-weight: bold; font-size: 18px; cursor: pointer; margin-top: 20px; }
        .btn:hover { background: #fff; box-shadow: 0 0 20px var(--display); }
    </style>
</head>
<body>

<div id="boot-screen" class="overlay">
    <h1 style="color:var(--display); font-size: 48px; letter-spacing: 10px;">METRO-TECH V1.0</h1>
    <p style="color:rgba(255,255,255,0.5)">FULL SYSTEM 3D SUBWAY SIMULATOR</p>
    <button class="btn" onclick="Game.init()">BOOT SYSTEM</button>
</div>

<div id="ui">
    <div class="glass-panel station-info">
        <div style="font-size: 10px; opacity: 0.7;">NEXT STATION</div>
        <div id="station-name" style="font-size: 20px; font-weight: bold;">CENTRAL TERMINAL</div>
        <div id="dist-text">DIST: 1200m</div>
    </div>

    <div class="glass-panel speedometer">
        <div class="speed-val" id="speed-num">0</div>
        <div style="font-size: 14px; letter-spacing: 3px;">KM/H</div>
        <div id="brake-status" style="font-size: 10px; margin-top: 10px; color: #ff4444;">BRAKE: RELEASED</div>
    </div>

    <div style="position: absolute; bottom: 40px; left: 40px;" class="glass-panel">
        <div>THRUST: <span id="thrust-val">0</span>%</div>
        <div style="width: 150px; height: 10px; background: #111; margin-top: 5px;">
            <div id="thrust-bar" style="width: 0%; height: 100%; background: var(--display);"></div>
        </div>
    </div>
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
import * as THREE from 'three';

/**
 * GAME ENGINE CORE
 */
const Game = {
    params: {
        tunnelRadius: 6,
        segmentLength: 200,
        maxSpeed: 120,
        accelRate: 15,
        friction: 0.992
    },
    state: {
        speed: 0,
        thrust: 0,
        distToStation: 1500,
        stationIdx: 0,
        zPos: 0
    },

    init() {
        document.getElementById('boot-screen').style.display = 'none';
        this.setupScene();
        this.createWorld();
        this.setupInputs();
        this.animate();
    },

    setupScene() {
        this.scene = new THREE.Scene();
        this.scene.fog = new THREE.FogExp2(0x000000, 0.02);
        
        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(this.renderer.domElement);

        // Train Headlights
        this.headlight = new THREE.SpotLight(0xffffff, 100);
        this.headlight.angle = Math.PI / 4;
        this.headlight.penumbra = 0.5;
        this.scene.add(this.headlight);
        this.scene.add(this.headlight.target);
    },

    createWorld() {
        this.tunnelGroup = new THREE.Group();
        this.scene.add(this.tunnelGroup);
        
        // Procedural Tunnel Generation
        for(let i=0; i<10; i++) {
            this.spawnTunnelSegment(i * -this.params.segmentLength);
        }

        // Add Tracks
        const trackGeo = new THREE.BoxGeometry(4, 0.2, 1000);
        const trackMat = new THREE.MeshStandardMaterial({ color: 0x111111, metalness: 0.9 });
        this.tracks = new THREE.Mesh(trackGeo, trackMat);
        this.tracks.position.y = -4.5;
        this.scene.add(this.tracks);
    },

    spawnTunnelSegment(z) {
        const tunnelGeo = new THREE.CylinderGeometry(this.params.tunnelRadius, this.params.tunnelRadius, this.params.segmentLength, 32, 1, true);
        tunnelGeo.rotateX(Math.PI / 2);
        
        // Concrete Texture Generation
        const canvas = document.createElement('canvas');
        canvas.width = 512; canvas.height = 512;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#222'; ctx.fillRect(0,0,512,512);
        ctx.strokeStyle = '#333';
        for(let i=0; i<512; i+=64) ctx.strokeRect(i,0,1,512);
        
        const tex = new THREE.CanvasTexture(canvas);
        tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
        tex.repeat.set(1, 4);

        const mat = new THREE.MeshStandardMaterial({ map: tex, side: THREE.BackSide });
        const mesh = new THREE.Mesh(tunnelGeo, mat);
        mesh.position.z = z;
        this.tunnelGroup.add(mesh);

        // Tunnel Lights
        const light = new THREE.PointLight(0xffaa44, 50, 20);
        light.position.set(0, 4, z);
        this.tunnelGroup.add(light);
    },

    setupInputs() {
        this.keys = {};
        window.addEventListener('keydown', e => this.keys[e.key.toLowerCase()] = true);
        window.addEventListener('keyup', e => this.keys[e.key.toLowerCase()] = false);
    },

    updatePhysics(dt) {
        // Thrust & Braking
        if(this.keys['w']) this.state.thrust = Math.min(100, this.state.thrust + 1);
        else if(this.keys['s']) this.state.thrust = Math.max(0, this.state.thrust - 2);
        
        if(this.keys[' ']) {
            this.state.speed *= 0.95; // Emergency Brake
            document.getElementById('brake-status').innerText = "BRAKE: ACTIVE";
            document.getElementById('brake-status').style.color = "#00ffcc";
        } else {
            this.state.speed += (this.state.thrust / 100) * this.params.accelRate * dt;
            this.state.speed *= this.params.friction;
            document.getElementById('brake-status').innerText = "BRAKE: RELEASED";
            document.getElementById('brake-status').style.color = "#ff4444";
        }

        this.state.zPos -= (this.state.speed * 0.5) * dt;
        this.state.distToStation -= (this.state.speed * 0.1) * dt;

        // Reset Dist if station reached
        if(this.state.distToStation < 0) this.state.distToStation = 2500;
    },

    animate() {
        requestAnimationFrame(() => this.animate());
        const dt = 0.016; // Fixed step for stability

        this.updatePhysics(dt);

        // Camera POV: Driver Seat
        this.camera.position.set(0, 0, this.state.zPos);
        this.headlight.position.set(0, 0, this.state.zPos);
        this.headlight.target.position.set(0, 0, this.state.zPos - 50);

        // Infinite Tunnel Loop
        this.tunnelGroup.children.forEach(seg => {
            if(seg.position.z > this.state.zPos + 50) {
                seg.position.z -= 10 * this.params.segmentLength;
            }
        });

        this.tracks.position.z = this.state.zPos - 500;

        // UI SYNC
        document.getElementById('speed-num').innerText = Math.floor(this.state.speed);
        document.getElementById('thrust-val').innerText = Math.floor(this.state.thrust);
        document.getElementById('thrust-bar').style.width = this.state.thrust + "%";
        document.getElementById('dist-text').innerText = `DIST: ${Math.floor(this.state.distToStation)}m`;

        this.renderer.render(this.scene, this.camera);
    }
};

window.Game = Game;
</script>
</body>
</html>
